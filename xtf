#!/bin/sh

export POSIXLY_CORRECT=yes
if [ -z "$XTF_PROFIT" ]; then
    export XTF_PROFIT=20
fi
# echo "hodnota = $XTF_PROFIT "

filtr(){
    if [ "$1" = "-a" ] ; then   #add processing for several filtres
        filtr_a=$1
        shift
        after=$1
        shift
        prikaz "$@"
    elif [ "$1" = "-b" ] ; then
        filtr_b=$1
        shift
        before=$1
        shift 
        prikaz "$@"
    elif [ "$1" = "-c" ] ; then
        filtr_c=$1
        shift
        currency=$1
        shift 
        prikaz "$@"   

    else
        prikaz "$@"
    fi

}

prikaz(){
    if [ "$1" = "list" ] || [ "$1" = "list-currency" ] || [ "$1" = "status" ] || [ "$1" = "profit" ]; then
        prikaz=$1
        shift
        uzivatel "$@"
    elif [ "$1" = "-a" ] || [ "$1" = "-b" ] || [ "$1" = "-c" ] ; then #for several filtres 
        filtr "$@"  
    else
        prikaz="list"
        uzivatel "$@"
    fi
}

uzivatel(){
    name=$1
    shift
    log "$@"
}

log(){
    if [ -z "$1" ]; then
        echo "no logfile" >&2
        exit 1 
    fi
    for arg in "$@"; do #for several logs
        if [ -f "$arg" ]; then  #chek if this is a file and write list of users
            case "$arg" in
            *.gz) 
                if [ -n "$newlist" ]; then   
                    appended_content=$(zcat "$arg")
                    newlist="$newlist\n""$appended_content"  #on my systen \n works correctly, on merlin no
                    # newlist=$(echo "$newlist" | cat "$appended_content")
                    # ЧОМУСЬ ВИНИКАЮТЬ ПОЧТОРКИ ЯКЩО ВЗЯТИ ЗІП ФАЙЛ І ЗВИЧАЙНИЙ ФАЙЛ З ПРІКАЗЕМ ЛІСТ
                else
                    newlist=$(zcat "$arg")
                fi
                ;;
            *) 
                if [ -n "$newlist" ]; then
                    newlist=$(echo "$newlist" | cat - "$arg")
                else
                    newlist=$(cat "$arg")
                fi
                ;;
            esac
            #filtering 
            if [ "$filtr_a" ]; then
                newlist=$(echo "$newlist" | awk -v date="$after" -F ';' '$2 > date' )
            fi
            if [ "$filtr_b" ]; then
                newlist=$(echo "$newlist" | awk -v date="$before" -F ';' '$2 < date' )
            fi
            if [ "$filtr_c" ]; then
                newlist=$(echo "$newlist" | awk -v currency="$currency" -F ';' '$3 == currency' )
            fi
        else
            echo "$1 is not a file" >&2
            exit 1
        fi

    done     
            if [ "$prikaz" = "list-currency" ]; then
                # grep "$name" "$arg" | awk -F ';' '{print $3}' | sort -u  #DOES NOT SORT IF THE ARE MULTIPLE FILES
                #search all lines with name and use awk to divide row by ; 
                #and write third part which contains currency
                # echo "$newlist" | grep "$name"| awk -F ';' '{print $3}' | sort -u #DOES NOT SORT IF THE ARE MULTIPLE FILES
                echo "$newlist" | grep "$name"| awk -F ';' '{print $3}' | sort -u    
            elif [ "$prikaz" = "list" ]; then
                # grep "$name" "$arg"
                # newlist=$(grep "$name" "$arg")
                # newlist=$(awk -v name="$name" '$0 ~ name')
                # echo "$newlist"
                # Пошук рядків, що містять задане ім'я у змінній newlist
                echo "$newlist" | grep "$name" | sort -u
                # echo "$newlist" | grep "$name"
            elif [ "$prikaz" = "status" ]; then
                echo "$newlist" | grep "$name"| awk -F ';' '
                    {
                        # Якщо ця валюта вже була зустрінута, додати баланс до суми для цієї валюти
                        if ($3 in currency_sum) {
                            currency_sum[$3] += $4
                        } else {
                            # Інакше створити новий запис для цієї валюти
                            currency_sum[$3] = $4
                        }
                    }
                    END {
                        # Вивести суму для кожної валюти
                        for (currency in currency_sum) {
                            printf "%s : %.4f\n" , currency , currency_sum[currency]
                        }
                    }
                ' | sort  #i hope this sort will sort currency by alfabet 

                # currency_list[@]=$(echo "$newlist" | grep "$name"| awk -F ';' '{ print $3 } ')
                # amount_list[@]=$(echo "$newlist" | grep "$name"| awk -F ';' '{ print $4 } ')
                # result=""

                # # Індекс для доступу до елементів масивів
                # index=0
 
                # # Об'єднання елементів масивів у вигляді "currency-amount"
                # while [ $index -lt ${#currency_list[@]} ]; do
                #     result="${result} ${currency_list[index]}-${amount_list[index]}"
                #     index=$((index + 1))
                # done

                # # Виведення результату
                # echo "$result"
                

            elif [ "$prikaz" = "profit" ]; then
                echo "$newlist" | grep "$name" | awk -F ';' -v XTF_PROFIT="$XTF_PROFIT" '
                    {
                        # Якщо ця валюта вже була зустрінута, додати баланс до суми для цієї валюти
                        if ($3 in currency_sum) {
                            currency_sum[$3] += $4
                        } else {
                            # Інакше створити новий запис для цієї валюти
                            currency_sum[$3] = $4
                        }
                    }
                    END {
                        # Вивести суму для кожної валюти
                        for (currency in currency_sum) {
                            if (currency_sum[currency] > 0){
                                # num = sprintf("%.4f", currency_sum[currency] * XTF_PROFIT * 0.01 )   #ВАРІАНТ ІЗ ЗАОКРУГЛЕННЯ, НЕ ВПЕВНЕНА ЩО ВІН  ПОТРІБНИЙ
                                num = currency_sum[currency] * XTF_PROFIT * 0.01
                                currency_sum[$3] +=  num
                            }
                            printf "%s : %.4f\n" , currency , currency_sum[currency]
                        }
                    }
                ' | sort

            fi
}

if [ "$1" = "-hl" ] || [ "$1" = "--help" ]; then
    echo "xtf [-h|--help] [FILTR] [PŘÍKAZ] UŽIVATEL LOG [LOG2 [...] "
    echo "
PŘÍKAZ může být jeden z:
    list – výpis záznamů pro daného uživatele.
    list-currency – výpis seřazeného seznamu vyskytujících se měn.
    status – výpis skutečného stavu účtu seskupeného a seřazeného dle jednotlivých měn.
    profit – výpis stavu účtu zákazníka se započítaným fiktivním výnosem.

FILTR může být kombinace následujících:
    -a DATETIME – after: jsou uvažovány pouze záznamy PO tomto datu a čase (bez něj). DATETIME je formátu YYYY-MM-DD HH:MM:SS.
    -b DATETIME – before: jsou uvažovány pouze záznamy PŘED tímto datem a časem (bez něj).
    -c CURRENCY – jsou uvažovány pouze záznamy odpovídající dané měně."

elif [ -z "$1" ]; then
    echo "no arguments" >&2
    exit 1
else
    filtr "$@"

fi
